<mat-drawer-container class="container" autosize>
  <mat-drawer-content>
    <h1 class="page-title">Users</h1>
    <p class="page-subtitle">Admin-only user management with server-side paging and role changes.</p>

    <mat-card class="filters">
      <mat-card-content>
        <form class="filters__grid" [formGroup]="form">
          <mat-form-field appearance="outline">
            <mat-label>Search</mat-label>
            <input matInput formControlName="search" placeholder="name or email" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Role</mat-label>
            <mat-select formControlName="role">
              <mat-option value="">All</mat-option>
              @for (r of roles; track r) {
                <mat-option [value]="r">{{ r }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </form>
      </mat-card-content>
    </mat-card>

    @if (vm$ | async; as vm) {
      @if (vm.loading) {
        <app-skeleton-cards [count]="6" variant="list"></app-skeleton-cards>
      } @else {
        @if (!vm.result || vm.result.total === 0) {
          <app-empty-state title="No users" message="Try adjusting filters." icon="group"></app-empty-state>
        } @else {
          <div class="results-bar">
            <div class="results-bar__count">{{ vm.result.total }} users</div>
            <mat-paginator
              [length]="vm.result.total"
              [pageIndex]="vm.result.page - 1"
              [pageSize]="vm.result.pageSize"
              [pageSizeOptions]="[10, 20, 50]"
              (page)="onPageChange($event.pageIndex, $event.pageSize)"
            ></mat-paginator>
          </div>

          <div class="table-wrap">
            <table mat-table [dataSource]="vm.result.items" class="table">
              <ng-container matColumnDef="user">
                <th mat-header-cell *matHeaderCellDef>User</th>
                <td mat-cell *matCellDef="let u">
                  <button class="user" type="button" (click)="openUser(u)">
                    <div class="user__name">{{ u.name }}</div>
                    <div class="user__email">{{ u.email }}</div>
                  </button>
                </td>
              </ng-container>

              <ng-container matColumnDef="role">
                <th mat-header-cell *matHeaderCellDef>Role</th>
                <td mat-cell *matCellDef="let u">
                  <mat-form-field appearance="outline" class="role-field">
                    <mat-select [value]="u.role" (selectionChange)="changeRole(u, $event.value)">
                      @for (r of roles; track r) {
                        <mat-option [value]="r">{{ r }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </td>
              </ng-container>

              <ng-container matColumnDef="created">
                <th mat-header-cell *matHeaderCellDef>Created</th>
                <td mat-cell *matCellDef="let u">{{ u.createdAt | date: 'mediumDate' }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['user', 'role', 'created']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['user', 'role', 'created']"></tr>
            </table>
          </div>
        }
      }
    }
  </mat-drawer-content>

  <mat-drawer position="end" mode="over" [opened]="!!selectedUserId" (closedStart)="closeDrawer()">
    @if (selectedUserId) {
      <app-user-detail-drawer [userId]="selectedUserId" (closed)="closeDrawer()"></app-user-detail-drawer>
    }
  </mat-drawer>
</mat-drawer-container>
