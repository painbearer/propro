<div class="header">
  <div>
    <h1 class="page-title">Recipes</h1>
    <p class="page-subtitle">Server-side paging, filtering, and sorting (simulated by the Mock API).</p>
  </div>
  <mat-button-toggle-group
    class="view-toggle"
    [value]="view"
    (change)="view = $event.value"
    aria-label="View mode"
  >
    <mat-button-toggle value="grid" aria-label="Grid view">
      <mat-icon>grid_view</mat-icon>
    </mat-button-toggle>
    <mat-button-toggle value="table" aria-label="Table view">
      <mat-icon>table_rows</mat-icon>
    </mat-button-toggle>
  </mat-button-toggle-group>
</div>

<mat-card class="filters">
  <mat-card-content>
    <form class="filters__grid" [formGroup]="form">
      <mat-form-field appearance="outline">
        <mat-label>Search</mat-label>
        <input matInput formControlName="textSearch" placeholder="Title, description, tags…" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Ingredient</mat-label>
        <input matInput formControlName="ingredientSearch" placeholder="e.g. garlic" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Tags</mat-label>
        <input matInput formControlName="tags" placeholder="comma-separated" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Category</mat-label>
        <mat-select formControlName="categoryId">
          <mat-option value="">All</mat-option>
          @for (c of categories$ | async; track c.id) {
            <mat-option [value]="c.id">{{ c.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Min rating</mat-label>
        <mat-select formControlName="minRating">
          <mat-option [value]="0">Any</mat-option>
          <mat-option [value]="3">3+</mat-option>
          <mat-option [value]="4">4+</mat-option>
          <mat-option [value]="4.5">4.5+</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Sort</mat-label>
        <mat-select formControlName="sortBy">
          <mat-option value="newest">Newest</mat-option>
          <mat-option value="rating">Rating</mat-option>
          <mat-option value="popularity">Popularity</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Direction</mat-label>
        <mat-select formControlName="sortDir">
          <mat-option value="desc">Desc</mat-option>
          <mat-option value="asc">Asc</mat-option>
        </mat-select>
      </mat-form-field>

      <div class="filters__actions">
        <button mat-stroked-button type="button" (click)="clear()">Clear</button>
      </div>
    </form>
  </mat-card-content>
</mat-card>

@if (vm$ | async; as vm) {
  @if (vm.loading) {
    <app-skeleton-cards [count]="12" [variant]="view === 'table' ? 'list' : 'recipe'"></app-skeleton-cards>
  } @else {
    @if (!vm.result || vm.result.total === 0) {
      <app-empty-state
        title="No recipes found"
        message="Try adjusting filters or clearing the search."
        icon="restaurant_menu"
        primaryActionLabel="Clear filters"
        primaryActionLink="/recipes"
      ></app-empty-state>
    } @else {
      <div class="results-bar">
        <div class="results-bar__count">{{ vm.result.total }} results</div>
        <mat-paginator
          [length]="vm.result.total"
          [pageIndex]="vm.query.page - 1"
          [pageSize]="vm.query.pageSize"
          [pageSizeOptions]="[12, 24, 48]"
          (page)="onPageChange($event.pageIndex, $event.pageSize)"
        ></mat-paginator>
      </div>

      @if (view === 'grid') {
        <div class="grid">
          @for (r of vm.result.items; track r.id) {
            <a class="card" [routerLink]="['/recipes', r.id]">
              <mat-card>
                <img mat-card-image [src]="r.imageUrl" [alt]="r.title" loading="lazy" />
                <mat-card-content>
                  <div class="title">{{ r.title }}</div>
                  <div class="desc">{{ r.description }}</div>
                  <div class="meta">
                    <app-rating-stars [rating]="r.avgRating" [readonly]="true"></app-rating-stars>
                    <span class="dot">•</span>
                    <span>{{ r.favoritesCount }} saves</span>
                    <span class="dot">•</span>
                    <span>{{ r.views }} views</span>
                  </div>
                  <div class="chips">
                    @for (t of r.tags.slice(0, 4); track t) {
                      <span class="chip">{{ t }}</span>
                    }
                  </div>
                </mat-card-content>
              </mat-card>
            </a>
          }
        </div>
      } @else {
        <div class="table-wrap">
          <table mat-table [dataSource]="vm.result.items" class="table">
            <ng-container matColumnDef="title">
              <th mat-header-cell *matHeaderCellDef>Recipe</th>
              <td mat-cell *matCellDef="let r">
                <a [routerLink]="['/recipes', r.id]" class="row-link">
                  <div class="row-title">{{ r.title }}</div>
                  <div class="row-sub">{{ r.description }}</div>
                </a>
              </td>
            </ng-container>

            <ng-container matColumnDef="rating">
              <th mat-header-cell *matHeaderCellDef>Rating</th>
              <td mat-cell *matCellDef="let r">
                <app-rating-stars [rating]="r.avgRating" [readonly]="true"></app-rating-stars>
              </td>
            </ng-container>

            <ng-container matColumnDef="pop">
              <th mat-header-cell *matHeaderCellDef>Popularity</th>
              <td mat-cell *matCellDef="let r">{{ r.favoritesCount }} saves</td>
            </ng-container>

            <ng-container matColumnDef="views">
              <th mat-header-cell *matHeaderCellDef>Views</th>
              <td mat-cell *matCellDef="let r">{{ r.views }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['title', 'rating', 'pop', 'views']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['title', 'rating', 'pop', 'views']"></tr>
          </table>
        </div>
      }
    }
  }
}
